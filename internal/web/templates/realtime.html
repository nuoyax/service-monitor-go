<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>window系统使用量实时监控</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <style>
      body {
        margin: 20px;
        font-family: sans-serif;
      }

      h2 {
        text-align: center;
      }

      /* 容器使用 Flexbox */
      .charts-container {
        display: flex;
        flex-wrap: wrap; /* 屏幕宽度不够自动换行 */
        gap: 20px; /* 图表之间的间距 */
        justify-content: center; /* 居中对齐 */
      }

      /* 每个图表盒子响应式宽度 */
      .chart-box {
        flex: 1 1 300px; /* 最小宽度 300px，自动伸缩 */
        max-width: 600px;
        height: 300px;
      }
    </style>
  </head>
  <body>
    <h2>系统使用量实时监控</h2>

    <div class="charts-container">
      <div id="cpuChart" class="chart-box"></div>
      <div id="memChart" class="chart-box"></div>
      <div id="diskChart" class="chart-box"></div>
      <div id="wifiChart" class="chart-box"></div>
      <div id="netChart" class="chart-box"></div>
    </div>

    <script>
      const labels = [];
      const cpuData = [];
      const memData = [];
      const diskData = [];
      const wifiData = [];
      const netUploadData = [];
      const netDownloadData = [];

      const cpuChart = echarts.init(document.getElementById("cpuChart"));
      const memChart = echarts.init(document.getElementById("memChart"));
      const diskChart = echarts.init(document.getElementById("diskChart"));
      const wifiChart = echarts.init(document.getElementById("wifiChart"));
      const netChart = echarts.init(document.getElementById("netChart"));

      function makeOption(title, data, color) {
        return {
          title: { text: title },
          tooltip: { trigger: "axis" },
          xAxis: { type: "category", data: labels },
          yAxis: { type: "value", max: 100 },
          series: [
            {
              data: data,
              type: "line",
              smooth: true,
              showSymbol: false,
              lineStyle: { color },
              areaStyle: { color, opacity: 0.1 },
              label: {
                show: true,
                position: "top",
                formatter: "{c}%",
              },
            },
          ],
        };
      }

      function makeNetOption() {
        return {
          title: {
            text: `网络速度 (上行: ${
              netUploadData[netUploadData.length - 1] || 0
            } Mbps 下载: ${
              netDownloadData[netDownloadData.length - 1] || 0
            } Mbps)`,
          },
          tooltip: { trigger: "axis" },
          legend: {
            data: ["上传", "下载"],
            bottom: 0, // 图例显示在底部
          },
          xAxis: { type: "category", data: labels },
          yAxis: { type: "value" },
          series: [
            {
              name: "上传",
              data: netUploadData,
              type: "line",
              smooth: true,
              lineStyle: { color: "orange" },
              areaStyle: { color: "orange", opacity: 0.1 },
              label: { show: true, position: "top", formatter: "{c} Mbps" },
            },
            {
              name: "下载",
              data: netDownloadData,
              type: "line",
              smooth: true,
              lineStyle: { color: "purple" },
              areaStyle: { color: "purple", opacity: 0.1 },
              label: { show: true, position: "top", formatter: "{c} Mbps" },
            },
          ],
        };
      }

      function updateCharts() {
        cpuChart.setOption(makeOption("CPU 使用率 %", cpuData, "red"));
        memChart.setOption(makeOption("内存 使用率 %", memData, "blue"));
        diskChart.setOption(makeOption("磁盘 使用率 %", diskData, "green"));
        wifiChart.setOption(makeOption("WiFi 信号强度 %", wifiData, "teal"));
        netChart.setOption(makeNetOption());
      }
      function parsePercent(value) {
        if (typeof value === "string") {
          // 去掉 '%'，转成数字
          return parseFloat(value.replace("%", ""));
        }
        return value; // 已经是数字
      }

      function fetchMetrics() {
        fetch("/metrics")
          .then((res) => res.json())
          .then((data) => {
            const time = new Date().toLocaleTimeString();
            labels.push(time);
            cpuData.push(Number(data.cpu_percent.toFixed(2)));
            memData.push(parsePercent(data.mem_percent).toFixed(2));
            diskData.push(parsePercent(data.disk_percent).toFixed(2));
            wifiData.push(Number(data.wifi_percent.toFixed(2)));
            netUploadData.push(Number(data.net_upload.toFixed(2)));
            netDownloadData.push(Number(data.net_download.toFixed(2)));

            if (labels.length > 20) {
              labels.shift();
              cpuData.shift();
              memData.shift();
              diskData.shift();
              wifiData.shift();
              netUploadData.shift();
              netDownloadData.shift();
            }

            updateCharts();
          });
      }

      setInterval(fetchMetrics, 2000);

      // 页面尺寸变化时重置图表大小
      window.addEventListener("resize", () => {
        cpuChart.resize();
        memChart.resize();
        diskChart.resize();
        wifiChart.resize();
        netChart.resize();
      });
    </script>
  </body>
</html>
